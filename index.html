<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/v/bs4/dt-1.10.24/af-2.3.5/b-1.7.0/cr-1.5.3/date-1.0.3/fc-3.3.2/fh-3.1.8/kt-2.6.1/r-2.2.7/rg-1.1.2/rr-1.2.7/sc-2.0.3/sb-1.0.1/sp-1.2.2/sl-1.3.3/datatables.min.css" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


</head>

<body>
    <div class="container mt-3">
        <div class="row mt-3">
            <div class="col-sm-12">
                <div class="card">
                    <h3 class="card-header text-center">
                        Films List from Sakila
                    </h3>
                    <div class="card-header">
                        <button type="button" id="btnLoadFilms" class="btn btn-lg btn-outline-info mr-3">
                            <i class="fa fa-refresh mr-2" aria-hidden="true"></i>Load
                        </button>
                        <button type="button" id="btnNewFilms" class="btn btn-lg btn-outline-primary mr-3"
                            data-toggle="modal" data-target="#newPopup">
                            <i class="fa fa-plus mr-2"></i>New
                        </button>
                        <!-- <button type="button" id="btnEditFilms" class="btn btn-lg btn-outline-primary">
                            <i class="fa fa-pencil-square-o"></i>
                        </button> -->

                        <button type="button" id="btnDeleteFilms"
                            class="btn btn-lg btn-outline-danger mr-3 float-right">
                            <i class="fa fa-times mr-2"></i>Delete
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover" id="table_id">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" name="select_all" value="0" id="example-select-all"></th>
                                    <th scope="col">Title</th>
                                    <th scope="col">Release Year</th>
                                    <th scope="col">Language</th>
                                    <th scope="col">Rating</th>
                                    <th scope="col">Special Features</th>
                                    <th scope="col">Replacement Cost</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody id='film_container'>
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer text-muted text-right">
                        conganhhcmus
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="newPopup" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">New Film</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="title" class="col-form-label">Title:</label>
                            <input type="text" required="required" placeholder="Film Name" class="form-control"
                                id="title">
                        </div>
                        <div class="form-group">
                            <label for="release_year" class="col-form-label">Release Year:</label>
                            <input type="number" required="required" placeholder="2001" class="form-control"
                                id="release_year">
                        </div>
                        <div class="form-group">
                            <label for="language" class="col-form-label">Language:</label>
                            <select name="language" id="language">
                                <option selected="selected" value=1>English</option>
                                <option value=2>Vietnamese</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rating" class="col-form-label">Rating:</label>
                            <!-- <input type="text" class="form-control" id="rating"> -->
                            <select name="rating" id="rating">
                                <option selected="selected" value="G">G</option>
                                <option value="PG">PG</option>
                                <option value="PG-13">PG-13</option>
                                <option value="R">R</option>
                                <option value="NC-17">NC-17</option>
                            </select>

                        </div>
                        <div class="form-group">
                            <label for="special_feature" class="col-form-label">Special Features:</label>
                            <input type="text" class="form-control" id="special_features">

                        </div>
                        <div class="form-group">
                            <label for="replacement_cost" class="col-form-label">Replacement Cost:</label>
                            <input type="number" placeholder="1.99" class="form-control" id="replacement_cost">
                        </div>
                    </form>
                </div>
                <div class="modal-footer ">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnAddFilm" class="btn btn-primary">Add</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="loadingPopup" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLoading">Loading</h5>
                    <button hidden=true type="button" class="close" data-dismiss="modal" aria-label="Close"
                        id='closeLoading'>
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                <div class="modal-footer ">
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <script type="text/javascript"
        src="https://cdn.datatables.net/v/bs4/dt-1.10.24/af-2.3.5/b-1.7.0/cr-1.5.3/date-1.0.3/fc-3.3.2/fh-3.1.8/kt-2.6.1/r-2.2.7/rg-1.1.2/rr-1.2.7/sc-2.0.3/sb-1.0.1/sp-1.2.2/sl-1.3.3/datatables.min.js"></script>


    <script>
        var table = $('#table_id').DataTable(
            {
                destroy: true,
                columnDefs: [{
                    orderable: false,
                    targets: 0,

                }, {
                    orderable: false,
                    targets: 7,

                }],
                order: [[1, 'asc']]
            }
        );


        var search = $('.dataTables_filter input').val();
        //Load ajax
        $('#btnLoadFilms').on('click', function () {
            search = $('.dataTables_filter input').val();
            $('#loadingPopup').modal('show');
            $.ajax({
                type: "get",
                url: "https://api-sakila.herokuapp.com/api/films"
            }).done(function (data) {
                setTimeout(function () { $("#loadingPopup").modal("hide"); }, 500);
                table.destroy();
                $('#film_container').empty();
                for (const f of data) {
                    const tr = `<tr>
                                    <td><input type="checkbox" name="id[]" value="${f.film_id}"></td>
                                    <td>${f.title}</td>
                                    <td>${f.release_year}</td>
                                    <td>${f.language_id}</td>
                                    <td>${f.rating}</td>
                                    <td>${f.special_features}</td>
                                    <td>${f.replacement_cost}</td>
                                    <td><button type="button" onclick="editFilm(${f.film_id})""
                                            class="btn btn-sm btn-outline-secondary">
                                            <i class="fa fa-pencil-square-o"></i>
                                        </button>
                                    </td>
                                </tr>`;
                    $('#film_container').append(tr);
                }

                table = $('#table_id').DataTable(
                    {
                        destroy: true,
                        columnDefs: [{
                            orderable: false,
                            targets: 0,

                        }, {
                            orderable: false,
                            targets: 7,

                        }],
                        order: [[1, 'asc']]
                    }
                );

                table.search(search).draw();
                // Handle click on "Select all" control
                $('#example-select-all').on('click', function () {
                    // Get all rows with search applied
                    var rows = table.rows({ 'search': 'applied' }).nodes();
                    // Check/uncheck checkboxes for all rows in the table
                    $('input[type="checkbox"]', rows).prop('checked', this.checked);
                });

                // Handle click on checkbox to set state of "Select all" control
                $('#film_container').on('change', 'input[type="checkbox"]', function () {
                    // If checkbox is not checked
                    if (!this.checked) {
                        var el = $('#example-select-all').get(0);
                        // If "Select all" control is checked and has 'indeterminate' property
                        if (el && el.checked && ('indeterminate' in el)) {
                            // Set visual state of "Select all" control
                            // as 'indeterminate'
                            el.indeterminate = true;
                        }
                    }
                });
            })
        });


        // New ajax
        $('#btnAddFilm').on('click', function () {
            search = $('.dataTables_filter input').val();
            const dataPost = {
                title: $('#title').val(),
                release_year: +$('#release_year').val(),
                language_id: +$('#language').val(),
                rating: $('#rating').val(),
                special_features: $('#special_features').val(),
                replacement_cost: +$('#replacement_cost').val(),
            }
            if (dataPost.release_year === 0 || dataPost.title === '') {
                alert("Name and Release Year must be filled out");
            }
            else {

                $.ajax({
                    type: "post",
                    url: "https://api-sakila.herokuapp.com/api/films/",
                    data: JSON.stringify(dataPost),
                    dataType: "json",
                    contentType: "application/json"
                }).done(function (data) {
                    console.log(data);
                    $('#newPopup').modal('hide');
                    Swal.fire({
                        // position: 'top-end',
                        icon: 'success',
                        title: 'Your work has been saved',
                        showConfirmButton: false,
                        timer: 1500
                    })
                    $('#btnLoadFilms').click();
                });
            }
        })

        $("#btnDeleteFilms").on('click', function () {
            var deleteIds = [];
            search = $('.dataTables_filter input').val();
            var rows = table.rows({ 'search': 'applied' }).nodes();
            // Check/uncheck checkboxes for all rows in the table
            $('input[type="checkbox"]', rows).each(function () {
                // If checkbox is checked
                if (this.checked) {
                    // Create a hidden element
                    deleteIds.push(this.value);
                }
            })

            console.log(deleteIds);
            for (const id of deleteIds) {
                $.ajax({
                    type: "delete",
                    url: `https://api-sakila.herokuapp.com/api/films/${id}`,
                }).done(function (data) {
                    Swal.fire({
                        // position: 'top-end',
                        icon: 'success',
                        title: 'Your work has been saved',
                        showConfirmButton: false,
                        timer: 1500
                    })
                    $('#btnLoadFilms').click();
                });
            }

        })

        function editFilm(id) {
            console.log(id);
        }

    </script>

</body>

</html>